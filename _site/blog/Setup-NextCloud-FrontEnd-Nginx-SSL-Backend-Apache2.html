<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="breuer.dev" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="breuer.dev" /> <title> Setup NextCloud Server with Nginx SSL Reverse-Proxy and Apache2 Backend - breuer.dev </title> <link rel="alternate" href="http://localhost:4000/blog/Setup-NextCloud-FrontEnd-Nginx-SSL-Backend-Apache2" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/blog/Setup-NextCloud-FrontEnd-Nginx-SSL-Backend-Apache2" /> <meta name="description" content="learning by doing" /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Setup NextCloud Server with Nginx SSL Reverse-Proxy and Apache2 Backend | Felix Breuer" /> <meta property="og:title" content="Setup NextCloud Server with Nginx SSL Reverse-Proxy and Apache2 Backend | Felix Breuer" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/blog/Setup-NextCloud-FrontEnd-Nginx-SSL-Backend-Apache2" /> <meta property="og:description" content="learning by doing" /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Setup NextCloud Server with Nginx SSL Reverse-Proxy and Apache2 Backend | felix_breuer" /> <meta name="twitter:url" content="http://localhost:4000/blog/Setup-NextCloud-FrontEnd-Nginx-SSL-Backend-Apache2" /> <meta name="twitter:site" content="@felix_breuer" /> <meta name="twitter:creator" content="@felix_breuer" /> <meta name="twitter:description" content="learning by doing" /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="breuer.dev" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#nextcloud">NEXTCLOUD</a>, <a class="tag" href="/tags/#server">SERVER</a>, <a class="tag" href="/tags/#ubuntu16-04">UBUNTU16.04</a>, <a class="tag" href="/tags/#setup">SETUP</a>, <a class="tag" href="/tags/#apache2">APACHE2</a>, <a class="tag" href="/tags/#nginx">NGINX</a>, <a class="tag" href="/tags/#reverseproxy">REVERSEPROXY</a>, <a class="tag" href="/tags/#ssl">SSL</a>, <a class="tag" href="/tags/#linux">LINUX</a> </span> </div> <h1 class="header-title" itemprop="headline">Setup NextCloud Server with Nginx SSL Reverse-Proxy and Apache2 Backend</h1> <div class="post-meta"> <time datetime="2018-04-18T18:00:00+02:00" itemprop="datePublished"> Apr 18, 2018 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Felix Breuer</span> </span> <time hidden datetime="" itemprop="dateModified"> Apr 18, 2018 </time> <span hidden itemprop="publisher" itemtype="Person">Felix Breuer</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>In the next few chapters we gonna setup a <a href="https://nextcloud.com">NextCloud</a> Server from scratch.<br /> There are a lot of tutorials out there already covering this topic, but in our case we gonna use <a href="http://nginx.org">Nginx</a> to serve the SSL-Certificates and proxy the connection to an <a href="https://httpd.apache.org">Apache2</a> service which is serving NextCloud.<br /> You can either use an existing Nginx configuration or follow the guide and deploy a new one.<!--more--></p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>In the next few chapters we gonna setup a <a href="https://nextcloud.com">NextCloud</a> Server from scratch.<br /> There are a lot of tutorials out there already covering this topic, but in our case we gonna use <a href="http://nginx.org">Nginx</a> to serve the SSL-Certificates and proxy the connection to an <a href="https://httpd.apache.org">Apache2</a> service which is serving NextCloud.<br /> You can either use an existing Nginx configuration or follow the guide and deploy a new one.<!--more--></p> <p>The Linux-Distribution doesn’t really matter if you are a little familiar with it, but we going to use <a href="https://ubuntu.com/download/server">Ubuntu Server 16.04 LTS</a>.<br /> For the purposes of this tutorial we gonna set up NextCloud under the Domain <strong>“https://cloud.example.com/”</strong>.<br /> Even though this is a step by step tutorial, it is always possible to skip some parts if you already configured them.</p> <h1 id="installing-nextcloud"> <a href="#installing-nextcloud" class="anchor-head"></a> Installing NextCloud </h1> <p>There are two ways of installing NextCloud.<br /> The first one is the fully automated option using ‘snap’ packages.<br /> I don’t recommend doing it this way because you don’t have control over everything you wanna do.<br /> Especially in a custom setup like ours, it is always better to do everything by yourself.</p> <h2 id="snap-install"> <a href="#snap-install" class="anchor-head"></a> ‘snap’ Install </h2> <p>Anyways, if you are a lazy person and want to take that risk… Lets’s go!<br /> If not already installed, install the <code class="language-plaintext highlighter-rouge">snap</code> package manager:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>snapd
</code></pre></div></div> <p>Get the NextCloud snap package:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>snap <span class="nb">install </span>nextcloud
</code></pre></div></div> <p>Install NextCloud:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nextcloud.manual-install replace_with_admin_username replace_with_admin_password
</code></pre></div></div> <h2 id="manual-install"> <a href="#manual-install" class="anchor-head"></a> Manual Install </h2> <p>In this chapter we are going through the installation step by step.<br /> First of all we need to install all dependencies. Don’t be scared… these are a lot but only small ones.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get upgrade
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>apache2 libapache2-mod-php7.0 bzip2
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>php7.0-gd php7.0-json php7.0-mysql php7.0-curl php7.0-mbstring
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>php7.0-intl php7.0-mcrypt php-imagick php7.0-xml php7.0-zip
</code></pre></div></div> <h3 id="sql-database"> <a href="#sql-database" class="anchor-head"></a> SQL Database </h3> <p>NextCloud is recommending <a href="https://mariadb.org">MariaDB</a> as the database software so let’s install and configure it:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>mariadb-server php-mysql
</code></pre></div></div> <p>MariaDB won’t set up any password for the <code class="language-plaintext highlighter-rouge">root</code> user. It is only possible to access the database via <code class="language-plaintext highlighter-rouge">sudo</code> command so we gonna ignore that for this tutorial.<br /> Enter the database:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>mysql <span class="nt">-u</span> root
</code></pre></div></div> <p>Create a database for NextCloud:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">nextcloud</span><span class="p">;</span>
</code></pre></div></div> <p>Create a user for NextCloud:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'replace_with_username'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'replace_with_password'</span><span class="p">;</span>
</code></pre></div></div> <p>Last step is to give the newly created user all privilegies for the new database:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="n">nextcloud</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'replace_with_username'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="o">#</span> <span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div></div> <p>Press <strong>CTRL + D</strong> to exit the mysql database.</p> <h3 id="nextcloud-files"> <a href="#nextcloud-files" class="anchor-head"></a> NextCloud Files </h3> <p>Download NextCloud-13 Files:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /var/www
<span class="nv">$ </span><span class="nb">sudo </span>wget https://download.nextcloud.com/server/releases/latest-13.tar.bz2 <span class="nt">-O</span> nextcloud-13-latest.tar.bz2
</code></pre></div></div> <p>Extract the archiv:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo tar</span> <span class="nt">-xvjf</span> nextcloud-13-latest.tar.bz2
</code></pre></div></div> <p>Grant the permissions recursivly and remove the downloaded archiv:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo chown</span> <span class="nt">-R</span> www-data:www-data nextcloud
<span class="nv">$ </span><span class="nb">sudo rm </span>nextcloud-13-latest.tar.bz2
</code></pre></div></div> <h1 id="configuring"> <a href="#configuring" class="anchor-head"></a> Configuring </h1> <p>The order in configuring all parts is irrelevant but if we do it in my way, we can test each step more efficiently.</p> <h2 id="apache2"> <a href="#apache2" class="anchor-head"></a> Apache2 </h2> <p>We will configure Apache to handle only localhost connections via http traffic.<br /> It will serve NextCloud on the backend. This is really comfortable because we don’t have to worry about Https-Traffic or SSL-Certs over here.</p> <p>First of all we have to make sure the Apache service isn’t listening on port 80 or 443. Nginx will do that in the future.<br /> We will change these ports to 8080 or 4443. Edit the <strong>/etc/apache2/ports.conf</strong> for listening on another port:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /etc/apache2
<span class="nv">$ </span><span class="nb">sudo </span>vi ports.conf
</code></pre></div></div> <p>Change <code class="language-plaintext highlighter-rouge">Listen 80</code> to <code class="language-plaintext highlighter-rouge">Listen 8080</code>.<br /> Save and close the File.</p> <p>Now we gonna create a new Virtual-Host file for NextCloud:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /etc/apache2/sites-available
<span class="nv">$ </span><span class="nb">sudo touch </span>nextcloud.conf
<span class="nv">$ </span><span class="nb">sudo </span>vi nextcloud.conf
</code></pre></div></div> <p>Paste in the following content:</p> <div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> 127.0.0.1:8080</span><span class="p">&gt;
</span>    <span class="nc">Alias</span> /nextcloud "/var/www/nextcloud/"

    <span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /var/www/nextcloud/</span><span class="p">&gt;
</span>        <span class="nc">Options</span> +FollowSymlinks
        <span class="nc">AllowOverride</span> <span class="ss">All</span>

        <span class="p">&lt;</span><span class="nl">IfModule</span><span class="sr"> mod_dav.c</span><span class="p">&gt;
</span>            <span class="nc">Dav</span> <span class="ss">off</span>
        <span class="p">&lt;/</span><span class="nl">IfModule</span><span class="p">&gt;
</span>
        <span class="nc">SetEnv</span> HOME /var/www/nextcloud
        <span class="nc">SetEnv</span> HTTP_HOME /var/www/nextcloud
    <span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
    <span class="nc">ErrorLog</span> /var/log/apache2/nextcloud-error_log
    <span class="nc">CustomLog</span> /var/log/apache2/nextcloud-access_log common
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div> <p>Enable the new host file and some mods NextCloud needs:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>a2ensite nextcloud
<span class="nv">$ </span><span class="nb">sudo </span>a2enmod rewrite headers <span class="nb">env dir </span>mime
</code></pre></div></div> <p>We can disable the default Apache site because Nginx is going to handle this. This will avoid problems between Apache and Nginx:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>a2dissite 000-default
</code></pre></div></div> <p>Restart Apache:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>service apache2 restart
</code></pre></div></div> <h2 id="nginx"> <a href="#nginx" class="anchor-head"></a> Nginx </h2> <p>Nginx will be our ‘Connection-Resolver’. Whenever an http or https request is made to our server, Nginx will decide what to do with it.<br /> We are going to set up a Server-Block, listening on port 443 and url “https://cloud.example.com/”, for the https-reverse-proxy to our NextCloud Apache service.<br /> If you want to see some more useful Server-Block examples, <a href="/tutorial/Nginx-Server-Blocks.html">Click Here!</a></p> <p>Install Nginx:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>nginx
</code></pre></div></div> <p><em>Optional:</em> I recommend setting up a firewall. <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-16-04">Click Here for a Digital Ocean Guide!</a><br /> Modify the Firewall to allow Nginx traffic (if installed):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>ufw allow <span class="s1">'Nginx Full'</span>
</code></pre></div></div> <p>Create a Server-Block file for NextCloud:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /etc/nginx/sites-available
<span class="nv">$ </span><span class="nb">sudo touch </span>nextcloud
<span class="nv">$ </span><span class="nb">sudo </span>vi nextcloud
</code></pre></div></div> <p>Paste in the following content:</p> <div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:443</span> <span class="s">ssl</span> <span class="s">http2</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">cloud.example.com</span><span class="p">;</span>

    <span class="kn">client_max_body_size</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kn">underscores_in_headers</span> <span class="no">on</span><span class="p">;</span>

    <span class="kn">location</span> <span class="p">~</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
        <span class="kn">add_header</span> <span class="s">Front-End-Https</span> <span class="no">on</span><span class="p">;</span>

        <span class="kn">proxy_headers_hash_max_size</span> <span class="mi">512</span><span class="p">;</span>
        <span class="kn">proxy_headers_hash_bucket_size</span> <span class="mi">64</span><span class="p">;</span>

        <span class="kn">proxy_buffering</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
        <span class="kn">proxy_max_temp_file_size</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Enable ‘nextcloud’ Server-Block:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-s</span> /etc/nginx/sites-available/nextcloud /etc/nginx/sites-enabled/
</code></pre></div></div> <p>Test the configuration file.<br /> If the output doesn’t display that the files are okay, check if you made a syntax or spelling mistake.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-t</span>
</code></pre></div></div> <p><em>Optional:</em> If you want to upload large files you should also increase the proxy-timeout settings in <strong>/etc/nginx/nginx.conf</strong>.<br /> Add the following lines anywhere in the <code class="language-plaintext highlighter-rouge">http {}</code> block:</p> <div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">proxy_connect_timeout</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">proxy_send_timeout</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">proxy_read_timeout</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">send_timeout</span> <span class="mi">1000</span><span class="p">;</span>
</code></pre></div></div> <p>Restart Nginx service:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>service nginx restart
</code></pre></div></div> <h3 id="ssl-certificates"> <a href="#ssl-certificates" class="anchor-head"></a> SSL-Certificates </h3> <p>There are a lot of tutorials out there covering that topic.<br /> You can either use self-signed certificates or let Let’s Enctypt handle that for you. We will roughly go through this chapter but if you want to have more overview just look at <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-let-s-encrypt-with-nginx-server-blocks-on-ubuntu-16-04">Digital Ocean’s Article</a> about setting up Nginx with Let’s Encrypt.</p> <p>Install Certbot:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>add-apt-repository ppa:certbot/certbot
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>python-certbot-nginx
</code></pre></div></div> <p>Make sure your Nginx configuration works and is set up with the correct <code class="language-plaintext highlighter-rouge">server_name</code>.<br /> Certbot will scan all of Nginx’s server blocks and searches for your domain name. The certificates then will be added to that configuration file automaticly.</p> <p>Obtaining cerificates:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>certbot <span class="nt">--nginx</span> <span class="nt">-d</span> cloud.example.com
</code></pre></div></div> <p>During this process we will be asked if Certbot should also redirect all Http traffic to Https.<br /> I recommend doing it on your own for example by checking out my <a href="/tutorial/Nginx-Server-Blocks.html">Server-Block Examples</a>.<br /> Otherwise just press ‘2’ and Certbot will handle that for us.</p> <h4 id="renewing-certificates"> <a href="#renewing-certificates" class="anchor-head"></a> Renewing Certificates </h4> <p>To renew the certificates when they are expired we can simply type:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>certbot renew
</code></pre></div></div> <p>As a lazy person I would highly suggest to set up a <code class="language-plaintext highlighter-rouge">crontab job</code> which runs this command every month.</p> <h3 id="optimizing-ssl-nginx-settings"> <a href="#optimizing-ssl-nginx-settings" class="anchor-head"></a> Optimizing SSL Nginx Settings </h3> <p>There is a really good guide how to customize your Nginx SSL-Settings to score an ‘A+’ on several Testsites.<br /> This step is optional and can be done later on if you are interested in that kind of stuff.<br /> <a href="/tutorial/Nginx-Server-Blocks.html">Useful Server-Blocks</a><br /> <a href="https://bjornjohansen.no/optimizing-https-nginx">External Arcticle</a></p> <h2 id="nextcloud"> <a href="#nextcloud" class="anchor-head"></a> Nextcloud </h2> <p>You can already access NextCloud via your domain, but it will be a little bit buggy.<br /> NextCloud still thinks that it’s been hosted on <code class="language-plaintext highlighter-rouge">127.0.0.1</code>. This will break some forwarding.</p> <p>To change these settings we have to edit the <code class="language-plaintext highlighter-rouge">config.php</code>file of NextCloud.<br /> Open <strong>/var/www/nextcloud/config/config.php</strong>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /var/www/nextcloud/config
<span class="nv">$ </span><span class="nb">sudo </span>vi config.php
</code></pre></div></div> <p>Insert or edit the following lines:</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'trusted_domains'</span> <span class="o">=&gt;</span>
<span class="k">array</span> <span class="p">(</span>
    <span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1:8080'</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'cloud.example.com'</span><span class="p">,</span>
<span class="p">),</span>
<span class="s1">'overwritehost'</span> <span class="o">=&gt;</span> <span class="s1">'cloud.example.com'</span><span class="p">,</span>
<span class="s1">'overwriteprotocol'</span> <span class="o">=&gt;</span> <span class="s1">'https'</span><span class="p">,</span>
<span class="s1">'overwritewebroot'</span> <span class="o">=&gt;</span> <span class="s1">'/'</span><span class="p">,</span>
<span class="s1">'overwrite.cli.url'</span> <span class="o">=&gt;</span> <span class="s1">'https://cloud.example.com/'</span><span class="p">,</span>
<span class="s1">'htaccess.RewriteBase'</span> <span class="o">=&gt;</span> <span class="s1">'/'</span><span class="p">,</span>
<span class="s1">'trusted_proxies'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'127.0.0.1'</span><span class="p">],</span>
</code></pre></div></div> <p>Save and close the file.</p> <p>Browse to <strong>https://cloud.example.com/</strong> and finish the guided setup.<br /> You have to enter the admin account details you want to use and the SQL user, password and database name we created in the tutorial.<br /> After submitting these infos NextCloud is ready to use.</p> </div> </article> <!-- unnecessary file, however you can still use for comment section, e.g disqus --> <script src="https://utteranc.es/client.js" repo="breuerfelix/breuerfelix.github.io" issue-term="pathname" label="comment" theme="github-dark" crossorigin="anonymous" async ></script> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/blog/Custom-Linux-Commands.html" > <div class="nav-arrow">Previous</div> <span class="post-title">Create custom Linux Commands</span> </a> <a class="post-nav-item post-nav-next" href="/blog/Nginx-Server-Blocks.html"> <div class="nav-arrow">Next</div> <span class="post-title">Useful Nginx Server Blocks</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2021</span> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
